---
title: "Final Project OPR/STA 9750"
author: "KWANG HEUM YEON"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here is my final project

• Project objective: The goal of this analysis is to predict the S&P 500 index based on the given variables from our dataset by applying a machine learning algorithm which is linear regression. 

• Introduction of dataset: 
This data comes from our Github repository. We gathered the real-time macroeconomic indexes from September 17, 2014, by using API-yfinance and then will get subsets. 

- Qualitative variable: date (‘mm-dd-yyyy’)

- Quantitative variable: CPI, Jclaim(Jobless claim), Int_rate(10 year bond rate),  Stock_price(S&P 500 index), Inf(Inflation rate), Choe(Choe volatility), Gold, Oil(Crude Oil), Bitcoin, Dollar(Dollar Index)


##Set-Up

```{r}
# import required libraries 

library(rvest)
library(sf)
library(tidyverse)
library(jsonlite)
library(tidycensus)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(gridExtra) 
```

##read data

```{r}
# import each data from the Github repository
# S&P 500 index
snp <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/snp.csv')
```

```{r}
# Crude oil
oil <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Oil.csv')
```

```{r}
# The number of weekly jobless claim 
jclaim <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Jclaim.csv')
```

```{r}
# FED Bond rate - 10yr 
int_rate <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Int_rate.csv')
```

```{r}
# Inflation rate
inf <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Inf.csv')
```

```{r}
# Gold
gold <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Gold.csv')
```

```{r}
# Dollar index
dollar <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Dollar.csv')
```

```{r}
# CPI index
cpi <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Cpi.csv')
```

```{r}
# Cboe volatility
cboe <- read.csv('https://raw.githubusercontent.com/cpasean/R/main/Cboe.csv')
```

##Join datasets

```{r}
df <- inner_join(snp, oil, by = "Date")
df <- inner_join(df, jclaim, by = "Date")
df <- inner_join(df, int_rate, by = "Date")   
df <- inner_join(df, inf, by = "Date")
df <- inner_join(df, gold, by = "Date")
df <- inner_join(df, dollar, by = "Date")
df <- inner_join(df, cpi, by = "Date")
df <- inner_join(df, cboe, by = "Date")
```

##Checklist: Data type, Null, and Five-number summary

```{r}
# check data type and range
str(df)
```

```{r}
# check Null 
any(is.na(df))
```

```{r}
# five-number summary
summary(df)
```

```{r}
# table name
names(df)
```

```{r}
# box plot
ggplot(aes(x = snp), data = df) +
  geom_boxplot()
```

```{r}
summary(df$snp)
```

```{r}
ggplot(aes(x = snp), data = df) +
  geom_histogram(binwidth = sd(df$snp)/20, fill = '#5760CB')
```
#Variable name, snp, is the target column so we got a boxplot and histogram and it has a right-skewed pattern having mode and mean at 2716 and 2864 respectively. 


##histogram for each variable 

```{r}
# set each bin proportional to the standard deviation 
# we adjusted the bin by dividing Std. by 20 

p1 <-ggplot(aes(x = Oil), data = df) +
  geom_histogram(binwidth = sd(df$Oil)/20, fill = '#5760CB')

p2 <-ggplot(aes(x = Jclaim), data = df) +
  geom_histogram(binwidth = sd(df$Jclaim)/20, fill = '#5760CB')

p3 <-ggplot(aes(x = Int_rate), data = df) +
  geom_histogram(binwidth = sd(df$Int_rate)/20, fill = '#5760CB')

p4 <- ggplot(aes(x = Inf.), data = df) +
  geom_histogram(binwidth = sd(df$Inf.)/20, fill = '#5760CB')

grid.arrange(p1, p2, p3, p4, ncol = 2)

```
# Jobless claim counts, has a right-skewed pattern. 
# Oil and the Inflation rate has a mode placed approximately at the center.
# Intereset rate has two modes on either side from the center and another two small at the edge of the range. The highest mode locates on the left side of the center.


```{r}
p1 <-ggplot(aes(x = Gold), data = df) +
  geom_histogram(binwidth = sd(df$Gold)/20, fill = '#5760CB')

p2 <-ggplot(aes(x = Dollar), data = df) +
  geom_histogram(binwidth = sd(df$Dollar)/20, fill = '#5760CB')

p3 <-ggplot(aes(x = Cpi), data = df) +
  geom_histogram(binwidth = sd(df$Cpi)/20, fill = '#5760CB')

p4 <-ggplot(aes(x = Cboe), data = df) +
  geom_histogram(binwidth = sd(df$Cboe)/20, fill = '#5760CB')

grid.arrange(p1, p2, p3, p4, ncol = 2)
```
# CPI and Cboe have a right-skewed pattern. 
# Dollar index has a slightly left-skewed pattern. 
# Gold has two modes. The highest mode locates on the left side of the center.


##S&P 500 average analysis for 30, 60, 90, and 120 days

```{r}
df_30 = df %>% tail(30)
df_60 = df %>% tail(60)
df_90 = df %>% tail(90)
df_120 = df %>% tail(120)

```


```{r}
p1 <- qplot(x = Date, y = snp, data = df_30) +
  theme(axis.text.x = element_text(angle = 45))

p2 <- qplot(x = Date, y = snp, data = df_60) +
  theme(axis.text.x = element_text(angle = 45))

p3 <- qplot(x = Date, y = snp, data = df_90) +
  theme(axis.text.x = element_text(angle = 45))

p4 <- qplot(x = Date, y = snp, data = df_120) +
  theme(axis.text.x = element_text(angle = 45))

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```
# Looking at the 30days graph, the index is going down for the entire range. 
# There were a huge swing of the index during the past 120 days.

##Historical record of all variables for the past 120 days.  

```{r}
p1 <- ggplot(aes(Date, snp), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p2 <- ggplot(aes(Date, Oil), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'red') +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p3 <- ggplot(aes(Date, Jclaim), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'green') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p4 <- ggplot(aes(Date, Int_rate), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p5 <- ggplot(aes(Date, Inf.), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p6 <- ggplot(aes(Date, Gold), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p7 <- ggplot(aes(Date, Dollar), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p8 <- ggplot(aes(Date, Cpi), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

p9 <- ggplot(aes(Date, Cboe), data = df_120) +
  geom_point(alpha = 0.15, 
             position = position_jitter(h = 0), 
             color = 'blue') + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, nrow = 3, ncol = 3)
```
# We can estimate that S&P 500 index has an inverse relationship with the oil price, interest rate, inflation rate, gold price, the dollar index, and customer price index(CPI)


## Before moving on to the machine learning algorithm, we want to understand how closely correlated each variable is. so, we will get the correlation coefficient matrix.
```{r}
names(df)
```

```{r}
# select wanted variable as a subset
df_subset <- df[, c(2:10)]
names(df_subset)
```

```{r}
# correlation coefficient matrix #1
cor(df_subset, method = 'pearson')
```

```{r}
# correlation coefficient matrix #2

# facet grid 
library(GGally)
theme_set(theme_minimal(10))

# set the seed for reproducible results
set.seed(1836)
names(df_subset)
ggpairs(df_subset[sample.int(nrow(df_subset), 10), ], axisLabels = 'internal')
```

```{r}
# correlation coefficient matrix #3

library(corrgram)
corrgram(df, lower.panel=panel.shade, upper.panel=panel.cor)
```

# S&P 500 has the highest correlation coefficient with CPI, and the lowest with the jobless claim count. With the interest rate, it's an inverse correlation coefficient. 
# We will get single linear regression for these three variables.

```{r}
# with CPI
ggplot(aes(x = snp, y = Cpi), data = df_subset) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red')
```
# S&P 500 index increased as the CPI index increased.

```{r}
# with Jobless claim counts
ggplot(aes(x = snp, y = Jclaim), data = df_subset) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red')
```
# S&P 500 index was not significantly affected by the CPI index.

```{r}
# with interest rate
ggplot(aes(x = snp, y = Int_rate), data = df_subset) +
  geom_point() + 
  geom_smooth(method = 'lm', color = 'red')
```
# S&P 500 index decreased as the interest rate increased.

##Multi-linear regression

```{r}
summary(lm(df_subset$snp ~ 
             df$Oil + 
             df$Jclaim + 
             df$Int_rate +
             df$Inf. + 
             df$Gold +
             df$Dollar + 
             df$Cpi +
             df$Cboe))

```
# We conducted a multi-linear regression to analyze the relationship between S&P 500 and the other variables. The R-squared in our model is 0.9834, meaning that 98.34% of the variability in the response - S&P 500 index is explained by the variables such as Oil, Jclaim, Int_rate, Inf., Gold, Dollar, Cpi, and Cboe. through the multi-linear regression model; in other words, the remaining 1.66% of the variability is due to characteristics that are not these variables. Finally, the low p-value explains that the variables, except Jclaim(Jobless claim counts), are statistically significant.


##Machine Learning - linear regression

```{r}
# random seed to get the same result
set.seed(42)
```

```{r}
# 70% of the data is used for training, and the remaining 30% is used for testing
library(caTools)
sampleSplit <- sample.split(Y = df$snp, SplitRatio=0.7)
trainSet <- subset(x=df, sampleSplit==TRUE)
testSet <- subset(x=df, sampleSplit==FALSE)
```


```{r}
# model training
model <- lm(trainSet$snp ~ 
             Oil + 
             Jclaim + 
             Int_rate +
             Inf. + 
             Gold +
             Dollar + 
             Cpi +
             Cboe, data = trainSet)
```

```{r}
# summary of our model
summary(model)
```
# R-squared and p-values of the fitted model are very slightly different from the previous result, which is a meaningful outcome. 

```{r}
modelResiduals <- as.data.frame(residuals(model)) 
```


##Make a residuals histogram to be more precise

```{r}
ggplot(modelResiduals, aes(residuals(model))) +
  geom_histogram(fill='deepskyblue', color='black')
```
# The histogram is a bit of skew due to the value on the far left, but we can conclude that the residuals are approximately normally distributed.

##Make prediction
```{r}
preds <- predict(model, testSet)
```

```{r}
# dataframe for actual and predicted values
modelEval <- cbind(testSet$snp, preds)
colnames(modelEval) <- c('Actual', 'Predicted')
modelEval <- as.data.frame(modelEval)
modelEval %>% head(3)
```
# Some of rows have a remarkable gap between the actual and predicted value, so we will check the accuracy.

##Test the accuracy

```{r}
# get MSE(Mean Square Error)
mse <- mean((modelEval$Actual - modelEval$Predicted)*(modelEval$Actual - modelEval$Predicted))

# get RMSE(Root Mean Square Error)
rmse <- sqrt(mse)
rmse
```
# We got the RMSE value of 105.74 meaning that the average predictions are incorrect by 105.74 units of features. 


• Conclusion 

We wanted to predict the S&P500 index based on the given features - Crude oil, the number of weekly jobless claims, 10-year bond rate, inflation rate, inflation rate, gold, the dollar index, CPI index, and Cboe volatility, from the dataset containing the historical record from September 17, 2014. From analysis for the past 120 days, we found that S&P 500 index has an inverse relationship with the oil price, interest rate, inflation rate, gold price, the dollar index, and customer price index(CPI). In addition, S&P 500 has the highest correlation coefficient with CPI and the lowest with the Jobless claim count. With the interest rate, it's an inverse correlation coefficient. S&P 500 index remarkably increased as the CPI index increased when we set the period as the entire range. This is the opposite of the previous 120-days analysis. 
We also conducted a multi-linear regression to analyze the relationship between S&P 500 and features. The R-squared in our model is 0.9834, meaning that 98.34% of the variability in the response - S&P 500 index is explained by the features except for Jclaim(Jobless claim counts). Finally, to predict the S&P 500 index, we fitted the training dataset into a machine learning algorithm – linear regression and get the RMSE value of 105.75 meaning that the average predictions are incorrect by 105.74 units of features.


• Motivation and Insights

Since the pandemic began, we are suffering from an economic downturn. The US government tried to subsidize people who lost their jobs so the economic stimulus plan has decreased the currency value. The stock market has the highest volatility for the first time in the past decade, the interest rate is increasing and the inflation rate is skyrocketing. The motivation of this project was to understand the economic trend with the analysis and finally cope with the uncertainty by minimizing the potential loss in our investment or financial planning.  We learned which macro indexes would positively or negatively affect the S&P 500 index, and how much. With the unexpectedly high r-squared from our analysis, we believe we can keep working on the consecutive research by applying different machine algorithms or additional variables worth putting in.


• Reference
Dario Radečić, (2022, December 24), Machine Learning with R: A Complete Guide to Linear Regression, https://www.r-bloggers.com/2020/12/machine-learning-with-r-a-complete-guide-to-linear-regression/